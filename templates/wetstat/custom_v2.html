<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Index</title>

    {% load static %}
    <link rel="stylesheet" href="{% static "fontawesome.css" %}">
    <link rel="stylesheet" href="{% static "style.css" %}">
    <link rel="stylesheet" href="{% static "bootstrap.min.css" %}"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>
<body>
<script src="{% static "jquery-3.3.1.slim.min.js" %}"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="{% static "popper.min.js" %}"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="{% static "bootstrap.min.js" %}"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<div class="topnav" id="myTopnav">
    <a href="/../">Home</a>
    <a href="/week">Woche</a>
    <a href="/month">Monat</a>
    <a href="/year">Jahr</a>
    <a class="active" href="">Bereich</a>
    <a href="javascript:void(0);" class="icon" onclick="topnavResponsive()">
        <i class="fa fa-bars"></i>
    </a>
</div>
<h1>Benutzerdefinierter Bereich</h1>
<form>
    <label>
        <select class="form-control" onchange="change_date_type()" id="id_change_date_type">
            <option value="fix">Fixes Start/Enddatum</option>
            <option value="relative">Relatives Start/Enddatum</option>
        </select>
    </label>
    <table id="id_start_end_fix" style="background-color:#cccccc; display: table;">
        <tr>
            <td>
                Startdatum:
            </td>
            <td>
                <label for="id_start_date"></label>
                <input type="datetime-local" name="start_date" value="{{ start_date }}" required="" id="id_start_date">
            </td>
        </tr>
        <tr>
            <td>
                Enddatum:
            </td>
            <td>
                <label for="id_end_date"></label>
                <input type="datetime-local" name="end_date" value="{{ end_date }}" required="" id="id_end_date">
            </td>
        </tr>
    </table>
    <table id="id_start_end_relative" style="background-color:#cccccc; display: none">
        <tr>
            <td></td>
            <td>Jahre</td>
            <td>Tage</td>
            <td>Stunden</td>
        </tr>
        <tr>
            <td>
                Startdatum:
            </td>
            <td>
                <label for="id_start_years"></label>
                <input id="id_start_years" type="number" min="0" max="100" value="0">
            </td>
            <td>
                <label for="id_start_days"></label>
                <input id="id_start_days" type="number" min="0" max="365" value="0">
            </td>
            <td>
                <label for="id_start_hours"></label>
                <input id="id_start_hours" type="number" min="0" max="23" value="0">
            </td>
        </tr>
        <tr>
            <td>
                Enddatum:
            </td>
            <td>
                <label for="id_end_years"></label>
                <input id="id_end_years" type="number" min="0" max="100" value="0">
            </td>
            <td>
                <label for="id_end_days"></label>
                <input id="id_end_days" type="number" min="0" max="365" value="1">
            </td>
            <td>
                <label for="id_end_hours"></label>
                <input id="id_end_hours" type="number" min="0" max="23" value="0">
            </td>
        </tr>
    </table>
    <br>
    <table>
        <tr>
            <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="id_check_title" onclick="update_disabling()">
                    <label class="form-check-label" for="id_check_title">
                        Anderer Titel
                    </label>
                </div>
            </td>
            <td colspan="3">
                <label for="id_input_title"></label>
                <input id="id_input_title" onchange="update_link()" onkeyup="update_link()">
            </td>
        </tr>
        <tr>
            <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="id_check_aspect" onclick="update_disabling()">
                    <label for="id_check_aspect" class="form-check-label">
                        Anderes Seitenverhältnis
                    </label>
                </div>
            </td>
            <td>
                <label for="id_input_aspect_w"></label>
                <input type="number" min="1" max="1000" value="16" id="id_input_aspect_w" onchange="update_link()"
                       onkeyup="update_link()">
            </td>
            <td>
                :
            </td>
            <td>
                <label for="id_input_aspect_h"></label>
                <input type="number" min="1" max="1000" value="9" id="id_input_aspect_h" onchange="update_link()"
                       onkeyup="update_link()">
            </td>
        </tr>

    </table>
    <br>
    <p>Sensoren:</p>
    <table id="id_sensor_table">
        <thead>
        <tr style="background-color: #cccccc; border-top-color: #000; border-top: 5px;">
            <th></th>
            <th>Sensor</th>
            <th>Y-Achse</th>
            <th>Zusammenführungs-Intervall</th>
            <th>Farbe</th>
        </tr>
        </thead>
        <tbody id="id_sensor_table_body">

        </tbody>
    </table>
    <button class="btn btn-primary" type="button" id="id_add_sensor_button" onclick="add_sensor()">Hinzufügen</button>
</form>
<p>Link zum Graph:</p>
<a id="id_result_link"></a>
<script>
    let available_sensors_short_name = {{ short_names }};
    let available_sensors_long_name = {{ long_names }};

    function add_sensor() {
        let st = document.getElementById("id_sensor_table_body");
        let row = st.insertRow(-1);

        let cell = row.insertCell(-1);
        let checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        cell.appendChild(checkbox);

        cell = row.insertCell(-1);
        let combobox = document.createElement("select");
        combobox.class = "form-control";
        for (let i in available_sensors_short_name) {
            let opt = document.createElement("option");
            opt.value = available_sensors_short_name[i];
            opt.innerHTML = available_sensors_long_name[i];
            combobox.appendChild(opt);
        }
        cell.appendChild(combobox);

        cell = row.insertCell(-1);
        let entry = document.createElement("input");
        entry.maxLength = 4;
        entry.size = 4;
        cell.appendChild(entry);
    }

    function change_date_type() {
        let t_fix = document.getElementById("id_start_end_fix");
        let t_rel = document.getElementById("id_start_end_relative");
        let di_fix = t_fix.style.display;
        let di_rel = t_rel.style.display;
        [di_fix, di_rel] = [di_rel, di_fix];
        t_fix.style.display = di_fix;
        t_rel.style.display = di_rel;
        update_link();
    }

    function update_link() {
        let date_type_sel = document.getElementById("id_change_date_type");
        let start, end;
        if (date_type_sel.selectedIndex === 0) {
            start = document.getElementById("id_start_date").value;
            end = document.getElementById("id_end_date").value;
        } else {
            start = document.getElementById("id_start_hours").valueAsNumber * 3600; // 3600 seconds = 1 hour
            start += document.getElementById("id_start_days").valueAsNumber * 3600 * 24;
            start += document.getElementById("id_start_years").valueAsNumber * 3600 * 24 * 365;
            start = "now-" + start;
            end = document.getElementById("id_end_hours").valueAsNumber * 3600;
            end += document.getElementById("id_end_days").valueAsNumber * 3600 * 24;
            end += document.getElementById("id_end_years").valueAsNumber * 3600 * 24 * 365;
            end = "now-" + end
        }

        let link = "/generate_plot";
        link += "?start=" + start;
        link += "&end=" + end;

        //todo: insert sensoroptions in link here

        let inp_title = document.getElementById("id_input_title");
        if (!inp_title.disabled) {
            link += "&title=" + inp_title.value
        }

        let input_aspect_w = document.getElementById("id_input_aspect_w");
        if (!input_aspect_w.disabled) {
            let input_aspect_h = document.getElementById("id_input_aspect_h");
            link += "&aspect_ratio=" + input_aspect_w.value + ":" + input_aspect_h.value;
        }

        let a = document.getElementById("id_result_link");
        a.href = link;
        a.innerText = a.href; // reading from 'a.href' because that's a absolute link now, 'link' is only relative
    }

    function update_disabling() {
        let check_title = document.getElementById("id_check_title");
        let input_title = document.getElementById("id_input_title");
        input_title.disabled = !check_title.checked;
        let check_aspect = document.getElementById("id_check_aspect");

        let input_aspect_w = document.getElementById("id_input_aspect_w");
        let input_aspect_h = document.getElementById("id_input_aspect_h");
        input_aspect_w.disabled = !check_aspect.checked;
        input_aspect_h.disabled = !check_aspect.checked;
        update_link();
    }

    update_disabling();
    update_link();
</script>
</body>
</html>